<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="简介cron一个用于管理定时任务的库，用 Go 实现 Linux 中crontab这个命令的效果。之前我们也介绍过一个类似的 Go 库——gron。gron代码小巧，用于学习是比较好的。但是它功能相对简单些，并且已经不维护了。如果有定时任务需求，还是建议使用cron。">
<meta property="og:type" content="article">
<meta property="og:title" content="Go每日一库之cron">
<meta property="og:url" content="https://www.jiebaiyou.com/2020/08/12/Go%E6%AF%8F%E6%97%A5%E4%B8%80%E5%BA%93%E4%B9%8Bcron/index.html">
<meta property="og:site_name" content="解百忧 · 随记">
<meta property="og:description" content="简介cron一个用于管理定时任务的库，用 Go 实现 Linux 中crontab这个命令的效果。之前我们也介绍过一个类似的 Go 库——gron。gron代码小巧，用于学习是比较好的。但是它功能相对简单些，并且已经不维护了。如果有定时任务需求，还是建议使用cron。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-08-12T02:23:06.000Z">
<meta property="article:modified_time" content="2021-06-30T09:57:22.127Z">
<meta property="article:author" content="解百忧">
<meta property="article:tag" content="go">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://www.jiebaiyou.com/2020/08/12/Go%E6%AF%8F%E6%97%A5%E4%B8%80%E5%BA%93%E4%B9%8Bcron/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Go每日一库之cron | 解百忧 · 随记</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">解百忧 · 随记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">那些比你走得远的人，并不比你聪慧，只是每天多走了一点。坚持，是最强大的力量。</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    

  <a href="https://github.com/jiebaiyou" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.jiebaiyou.com/2020/08/12/Go%E6%AF%8F%E6%97%A5%E4%B8%80%E5%BA%93%E4%B9%8Bcron/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="解百忧">
      <meta itemprop="description" content="分享学习记录">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="解百忧 · 随记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Go每日一库之cron
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-12 10:23:06" itemprop="dateCreated datePublished" datetime="2020-08-12T10:23:06+08:00">2020-08-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-30 17:57:22" itemprop="dateModified" datetime="2021-06-30T17:57:22+08:00">2021-06-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/" itemprop="url" rel="index">
                    <span itemprop="name">技术分享</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><a href="https://github.com/robfig/cron" target="_blank" rel="noopener"><code>cron</code></a>一个用于管理定时任务的库，用 Go 实现 Linux 中<code>crontab</code>这个命令的效果。之前我们也介绍过一个类似的 Go 库——<a href="https://darjun.github.io/2020/04/20/godailylib/gron/" target="_blank" rel="noopener"><code>gron</code></a>。<code>gron</code>代码小巧，用于学习是比较好的。但是它功能相对简单些，并且已经不维护了。如果有定时任务需求，还是建议使用<code>cron</code>。</p>
<a id="more"></a>

<h2 id="快速使用"><a href="#快速使用" class="headerlink" title="快速使用"></a>快速使用</h2><p>文本代码使用 Go Modules。</p>
<p>创建目录并初始化：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> cron &amp;&amp; <span class="built_in">cd</span> cron</span><br><span class="line">$ go mod init github.com/darjun/go-daily-lib/cron</span><br><span class="line"><span class="number">12</span></span><br></pre></td></tr></table></figure>

<p>安装<code>cron</code>，目前最新稳定版本为 v3：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go get -u github.com/robfig/cron/v3</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>使用：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"fmt"</span></span><br><span class="line">  <span class="string">"time"</span></span><br><span class="line"></span><br><span class="line">  <span class="string">"github.com/robfig/cron/v3"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  c := cron.New()</span><br><span class="line"></span><br><span class="line">  c.AddFunc(<span class="string">"@every 1s"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"tick every 1 second"</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  c.Start()</span><br><span class="line">  time.Sleep(time.Second * <span class="number">5</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">12345678910111213141516171819</span></span><br></pre></td></tr></table></figure>

<p>使用非常简单，创建<code>cron</code>对象，这个对象用于管理定时任务。</p>
<p>调用<code>cron</code>对象的<code>AddFunc()</code>方法向管理器中添加定时任务。<code>AddFunc()</code>接受两个参数，参数 1 以字符串形式指定触发时间规则，参数 2 是一个无参的函数，每次触发时调用。<code>@every 1s</code>表示每秒触发一次，<code>@every</code>后加一个时间间隔，表示每隔多长时间触发一次。例如<code>@every 1h</code>表示每小时触发一次，<code>@every 1m2s</code>表示每隔 1 分 2 秒触发一次。<code>time.ParseDuration()</code>支持的格式都可以用在这里。</p>
<p>调用<code>c.Start()</code>启动定时循环。</p>
<p>注意一点，因为<code>c.Start()</code>启动一个新的 goroutine 做循环检测，我们在代码最后加了一行<code>time.Sleep(time.Second * 5)</code>防止主 goroutine 退出。</p>
<p>运行效果，每隔 1s 输出一行字符串：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go </span><br><span class="line">tick every <span class="number">1</span> second</span><br><span class="line">tick every <span class="number">1</span> second</span><br><span class="line">tick every <span class="number">1</span> second</span><br><span class="line">tick every <span class="number">1</span> second</span><br><span class="line">tick every <span class="number">1</span> second</span><br><span class="line"><span class="number">123456</span></span><br></pre></td></tr></table></figure>

<h2 id="时间格式"><a href="#时间格式" class="headerlink" title="时间格式"></a>时间格式</h2><p>与Linux 中<code>crontab</code>命令相似，<code>cron</code>库支持用 <strong>5</strong> 个空格分隔的域来表示时间。这 5 个域含义依次为：</p>
<ul>
<li><code>Minutes</code>：分钟，取值范围<code>[0-59]</code>，支持特殊字符<code>* / , -</code>；</li>
<li><code>Hours</code>：小时，取值范围<code>[0-23]</code>，支持特殊字符<code>* / , -</code>；</li>
<li><code>Day of month</code>：每月的第几天，取值范围<code>[1-31]</code>，支持特殊字符<code>* / , - ?</code>；</li>
<li><code>Month</code>：月，取值范围<code>[1-12]</code>或者使用月份名字缩写<code>[JAN-DEC]</code>，支持特殊字符<code>* / , -</code>；</li>
<li><code>Day of week</code>：周历，取值范围<code>[0-6]</code>或名字缩写<code>[JUN-SAT]</code>，支持特殊字符<code>* / , - ?</code>。</li>
</ul>
<p>注意，月份和周历名称都是不区分大小写的，也就是说<code>SUN/Sun/sun</code>表示同样的含义（都是周日）。</p>
<p>特殊字符含义如下：</p>
<ul>
<li><code>*</code>：使用<code>*</code>的域可以匹配任何值，例如将月份域（第 4 个）设置为<code>*</code>，表示每个月；</li>
<li><code>/</code>：用来指定范围的<strong>步长</strong>，例如将小时域（第 2 个）设置为<code>3-59/15</code>表示第 3 分钟触发，以后每隔 15 分钟触发一次，因此第 2 次触发为第 18 分钟，第 3 次为 33 分钟。。。直到分钟大于 59；</li>
<li><code>,</code>：用来列举一些离散的值和多个范围，例如将周历的域（第 5 个）设置为<code>MON,WED,FRI</code>表示周一、三和五；</li>
<li><code>-</code>：用来表示范围，例如将小时的域（第 1 个）设置为<code>9-17</code>表示上午 9 点到下午 17 点（包括 9 和 17）；</li>
<li><code>?</code>：只能用在月历和周历的域中，用来代替<code>*</code>，表示每月/周的任意一天。</li>
</ul>
<p>了解规则之后，我们可以定义任意时间：</p>
<ul>
<li><code>30 * * * *</code>：分钟域为 30，其他域都是<code>*</code>表示任意。每小时的 30 分触发；</li>
<li><code>30 3-6,20-23 * * *</code>：分钟域为 30，小时域的<code>3-6,20-23</code>表示 3 点到 6 点和 20 点到 23 点。3,4,5,6,20,21,22,23 时的 30 分触发；</li>
<li><code>0 0 1 1 *</code>：1（第 4 个） 月 1（第 3 个） 号的 0（第 2 个） 时 0（第 1 个） 分触发。</li>
</ul>
<p>记熟了这几个域的顺序，再多练习几次很容易就能掌握格式。熟悉规则了之后，就能熟练使用<code>crontab</code>命令了。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  c := cron.New()</span><br><span class="line"></span><br><span class="line">  c.AddFunc(<span class="string">"30 * * * *"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"Every hour on the half hour"</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  c.AddFunc(<span class="string">"30 3-6,20-23 * * *"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"On the half hour of 3-6am, 8-11pm"</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  c.AddFunc(<span class="string">"0 0 1 1 *"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"Jun 1 every year"</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  c.Start()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    time.Sleep(time.Second)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456789101112131415161718192021</span></span><br></pre></td></tr></table></figure>

<h3 id="预定义时间规则"><a href="#预定义时间规则" class="headerlink" title="预定义时间规则"></a>预定义时间规则</h3><p>为了方便使用，<code>cron</code>预定义了一些时间规则：</p>
<ul>
<li><code>@yearly</code>：也可以写作<code>@annually</code>，表示每年第一天的 0 点。等价于<code>0 0 1 1 *</code>；</li>
<li><code>@monthly</code>：表示每月第一天的 0 点。等价于<code>0 0 1 * *</code>；</li>
<li><code>@weekly</code>：表示每周第一天的 0 点，注意第一天为周日，即周六结束，周日开始的那个 0 点。等价于<code>0 0 * * 0</code>；</li>
<li><code>@daily</code>：也可以写作<code>@midnight</code>，表示每天 0 点。等价于<code>0 0 * * *</code>；</li>
<li><code>@hourly</code>：表示每小时的开始。等价于<code>0 * * * *</code>。</li>
</ul>
<p>例如：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  c := cron.New()</span><br><span class="line"></span><br><span class="line">  c.AddFunc(<span class="string">"@hourly"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"Every hour"</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  c.AddFunc(<span class="string">"@daily"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"Every day on midnight"</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  c.AddFunc(<span class="string">"@weekly"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"Every week"</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  c.Start()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    time.Sleep(time.Second)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456789101112131415161718192021</span></span><br></pre></td></tr></table></figure>

<p>上面代码只是演示用法，实际运行可能要等待非常长的时间才能有输出。</p>
<h3 id="固定时间间隔"><a href="#固定时间间隔" class="headerlink" title="固定时间间隔"></a>固定时间间隔</h3><p><code>cron</code>支持固定时间间隔，格式为：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@every &lt;duration&gt;</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>含义为每隔<code>duration</code>触发一次。<code>&lt;duration&gt;</code>会调用<code>time.ParseDuration()</code>函数解析，所以<code>ParseDuration</code>支持的格式都可以。例如<code>1h30m10s</code>。在快速开始部分，我们已经演示了<code>@every</code>的用法了，这里就不赘述了。</p>
<h2 id="时区"><a href="#时区" class="headerlink" title="时区"></a>时区</h2><p>默认情况下，所有时间都是基于当前时区的。当然我们也可以指定时区，有 2 两种方式：</p>
<ul>
<li>在时间字符串前面添加一个<code>CRON_TZ=</code> + 具体时区，具体时区的格式在之前<a href="https://darjun.github.io/2020/02/14/godailylib/carbon/" target="_blank" rel="noopener"><code>carbon</code></a>的文章中有详细介绍。东京时区为<code>Asia/Tokyo</code>，纽约时区为<code>America/New_York</code>；</li>
<li>创建<code>cron</code>对象时增加一个时区选项<code>cron.WithLocation(location)</code>，<code>location</code>为<code>time.LoadLocation(zone)</code>加载的时区对象，<code>zone</code>为具体的时区格式。或者调用已创建好的<code>cron</code>对象的<code>SetLocation()</code>方法设置时区。</li>
</ul>
<p>示例：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  nyc, _ := time.LoadLocation(<span class="string">"America/New_York"</span>)</span><br><span class="line">  c := cron.New(cron.WithLocation(nyc))</span><br><span class="line">  c.AddFunc(<span class="string">"0 6 * * ?"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"Every 6 o'clock at New York"</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  c.AddFunc(<span class="string">"CRON_TZ=Asia/Tokyo 0 6 * * ?"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"Every 6 o'clock at Tokyo"</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  c.Start()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    time.Sleep(time.Second)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234567891011121314151617</span></span><br></pre></td></tr></table></figure>

<h2 id="Job接口"><a href="#Job接口" class="headerlink" title="Job接口"></a><code>Job</code>接口</h2><p>除了直接将无参函数作为回调外，<code>cron</code>还支持<code>Job</code>接口：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cron.go</span></span><br><span class="line"><span class="keyword">type</span> Job <span class="keyword">interface</span> &#123;</span><br><span class="line">  Run()</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234</span></span><br></pre></td></tr></table></figure>

<p>我们定义一个实现接口<code>Job</code>的结构：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GreetingJob <span class="keyword">struct</span> &#123;</span><br><span class="line">  Name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g GreetingJob)</span> <span class="title">Run</span><span class="params">()</span></span> &#123;</span><br><span class="line">  fmt.Println(<span class="string">"Hello "</span>, g.Name)</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234567</span></span><br></pre></td></tr></table></figure>

<p>调用<code>cron</code>对象的<code>AddJob()</code>方法将<code>GreetingJob</code>对象添加到定时管理器中：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  c := cron.New()</span><br><span class="line">  c.AddJob(<span class="string">"@every 1s"</span>, GreetingJob&#123;<span class="string">"dj"</span>&#125;)</span><br><span class="line">  c.Start()</span><br><span class="line"></span><br><span class="line">  time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234567</span></span><br></pre></td></tr></table></figure>

<p>运行效果：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go </span><br><span class="line">Hello  dj</span><br><span class="line">Hello  dj</span><br><span class="line">Hello  dj</span><br><span class="line">Hello  dj</span><br><span class="line">Hello  dj</span><br><span class="line"><span class="number">123456</span></span><br></pre></td></tr></table></figure>

<p>使用自定义的结构可以让任务携带状态（<code>Name</code>字段）。</p>
<p>实际上<code>AddFunc()</code>方法内部也调用了<code>AddJob()</code>方法。首先，<code>cron</code>基于<code>func()</code>类型定义一个新的类型<code>FuncJob</code>：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cron.go</span></span><br><span class="line"><span class="keyword">type</span> FuncJob <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function">12</span></span><br></pre></td></tr></table></figure>

<p>然后让<code>FuncJob</code>实现<code>Job</code>接口：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cron.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f FuncJob)</span> <span class="title">Run</span><span class="params">()</span></span> &#123;</span><br><span class="line">  f()</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234</span></span><br></pre></td></tr></table></figure>

<p>在<code>AddFunc()</code>方法中，将传入的回调转为<code>FuncJob</code>类型，然后调用<code>AddJob()</code>方法：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cron)</span> <span class="title">AddFunc</span><span class="params">(spec <span class="keyword">string</span>, cmd <span class="keyword">func</span>()</span>) <span class="params">(EntryID, error)</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> c.AddJob(spec, FuncJob(cmd))</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>

<h2 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h2><p><code>cron</code>会创建一个新的 goroutine 来执行触发回调。如果这些回调需要并发访问一些资源、数据，我们需要显式地做同步。</p>
<h2 id="自定义时间格式"><a href="#自定义时间格式" class="headerlink" title="自定义时间格式"></a>自定义时间格式</h2><p><code>cron</code>支持灵活的时间格式，如果默认的格式不能满足要求，我们可以自己定义时间格式。时间规则字符串需要<code>cron.Parser</code>对象来解析。我们先来看看默认的解析器是如何工作的。</p>
<p>首先定义各个域：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parser.go</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  Second         ParseOption = <span class="number">1</span> &lt;&lt; <span class="literal">iota</span></span><br><span class="line">  SecondOptional                        </span><br><span class="line">  Minute                                </span><br><span class="line">  Hour                                  </span><br><span class="line">  Dom                                   </span><br><span class="line">  Month                                 </span><br><span class="line">  Dow                                   </span><br><span class="line">  DowOptional                           </span><br><span class="line">  Descriptor                            </span><br><span class="line">)</span><br><span class="line"><span class="number">123456789101112</span></span><br></pre></td></tr></table></figure>

<p>除了<code>Minute/Hour/Dom(Day of month)/Month/Dow(Day of week)</code>外，还可以支持<code>Second</code>。相对顺序都是固定的：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parser.go</span></span><br><span class="line"><span class="keyword">var</span> places = []ParseOption&#123;</span><br><span class="line">  Second,</span><br><span class="line">  Minute,</span><br><span class="line">  Hour,</span><br><span class="line">  Dom,</span><br><span class="line">  Month,</span><br><span class="line">  Dow,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> defaults = []<span class="keyword">string</span>&#123;</span><br><span class="line">  <span class="string">"0"</span>,</span><br><span class="line">  <span class="string">"0"</span>,</span><br><span class="line">  <span class="string">"0"</span>,</span><br><span class="line">  <span class="string">"*"</span>,</span><br><span class="line">  <span class="string">"*"</span>,</span><br><span class="line">  <span class="string">"*"</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456789101112131415161718</span></span><br></pre></td></tr></table></figure>

<p>默认的时间格式使用 5 个域。</p>
<p>我们可以调用<code>cron.NewParser()</code>创建自己的<code>Parser</code>对象，以位格式传入使用哪些域，例如下面的<code>Parser</code>使用 6 个域，支持<code>Second</code>（秒）：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">parser := cron.NewParser(</span><br><span class="line">  cron.Second | cron.Minute | cron.Hour | cron.Dom | cron.Month | cron.Dow | cron.Descriptor,</span><br><span class="line">)</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>

<p>调用<code>cron.WithParser(parser)</code>创建一个选项传入构造函数<code>cron.New()</code>，使用时就可以指定秒了：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">c := cron.New(cron.WithParser(parser))</span><br><span class="line">c.AddFunc(<span class="string">"1 * * * * *"</span>, <span class="function"><span class="keyword">func</span> <span class="params">()</span></span> &#123;</span><br><span class="line">  fmt.Println(<span class="string">"every 1 second"</span>)</span><br><span class="line">&#125;)</span><br><span class="line">c.Start()</span><br><span class="line"><span class="number">12345</span></span><br></pre></td></tr></table></figure>

<p>这里时间格式必须使用 6 个域，顺序与上面的<code>const</code>定义一致。</p>
<p>因为上面的时间格式太常见了，<code>cron</code>定义了一个便捷的函数：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// option.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithSeconds</span><span class="params">()</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> WithParser(NewParser(</span><br><span class="line">    Second | Minute | Hour | Dom | Month | Dow | Descriptor,</span><br><span class="line">  ))</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456</span></span><br></pre></td></tr></table></figure>

<p>注意<code>Descriptor</code>表示对<code>@every/@hour</code>等的支持。有了<code>WithSeconds()</code>，我们不用手动创建<code>Parser</code>对象了：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c := cron.New(cron.WithSeconds())</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h2><p><code>cron</code>对象创建使用了选项模式，我们前面已经介绍了 3 个选项：</p>
<ul>
<li><code>WithLocation</code>：指定时区；</li>
<li><code>WithParser</code>：使用自定义的解析器；</li>
<li><code>WithSeconds</code>：让时间格式支持秒，实际上内部调用了<code>WithParser</code>。</li>
</ul>
<p><code>cron</code>还提供了另外两种选项：</p>
<ul>
<li><code>WithLogger</code>：自定义<code>Logger</code>；</li>
<li><code>WithChain</code>：Job 包装器。</li>
</ul>
<h3 id="WithLogger"><a href="#WithLogger" class="headerlink" title="WithLogger"></a><code>WithLogger</code></h3><p><code>WithLogger</code>可以设置<code>cron</code>内部使用我们自定义的<code>Logger</code>：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  c := cron.New(</span><br><span class="line">    cron.WithLogger(</span><br><span class="line">      cron.VerbosePrintfLogger(log.New(os.Stdout, <span class="string">"cron: "</span>, log.LstdFlags))))</span><br><span class="line">  c.AddFunc(<span class="string">"@every 1s"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"hello world"</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  c.Start()</span><br><span class="line"></span><br><span class="line">  time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234567891011</span></span><br></pre></td></tr></table></figure>

<p>上面调用<code>cron.VerbosPrintfLogger()</code>包装<code>log.Logger</code>，这个<code>logger</code>会详细记录<code>cron</code>内部的调度过程：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line"><span class="function">cron: 2020/06/26 07:09:14 <span class="title">start</span></span></span><br><span class="line"><span class="function"><span class="title">cron</span>: 2020/06/26 07:09:14 <span class="title">schedule</span>, <span class="title">now</span>=2020-06-26<span class="title">T07</span>:09:14+08:00, <span class="title">entry</span>=1, <span class="title">next</span>=2020-06-26<span class="title">T07</span>:09:15+08:00</span></span><br><span class="line"><span class="function"><span class="title">cron</span>: 2020/06/26 07:09:15 <span class="title">wake</span>, <span class="title">now</span>=2020-06-26<span class="title">T07</span>:09:15+08:00</span></span><br><span class="line"><span class="function"><span class="title">cron</span>: 2020/06/26 07:09:15 <span class="title">run</span>, <span class="title">now</span>=2020-06-26<span class="title">T07</span>:09:15+08:00, <span class="title">entry</span>=1, <span class="title">next</span>=2020-06-26<span class="title">T07</span>:09:16+08:00</span></span><br><span class="line"><span class="function"><span class="title">hello</span> <span class="title">world</span></span></span><br><span class="line"><span class="function"><span class="title">cron</span>: 2020/06/26 07:09:16 <span class="title">wake</span>, <span class="title">now</span>=2020-06-26<span class="title">T07</span>:09:16+08:00</span></span><br><span class="line"><span class="function"><span class="title">cron</span>: 2020/06/26 07:09:16 <span class="title">run</span>, <span class="title">now</span>=2020-06-26<span class="title">T07</span>:09:16+08:00, <span class="title">entry</span>=1, <span class="title">next</span>=2020-06-26<span class="title">T07</span>:09:17+08:00</span></span><br><span class="line"><span class="function"><span class="title">hello</span> <span class="title">world</span></span></span><br><span class="line"><span class="function"><span class="title">cron</span>: 2020/06/26 07:09:17 <span class="title">wake</span>, <span class="title">now</span>=2020-06-26<span class="title">T07</span>:09:17+08:00</span></span><br><span class="line"><span class="function"><span class="title">cron</span>: 2020/06/26 07:09:17 <span class="title">run</span>, <span class="title">now</span>=2020-06-26<span class="title">T07</span>:09:17+08:00, <span class="title">entry</span>=1, <span class="title">next</span>=2020-06-26<span class="title">T07</span>:09:18+08:00</span></span><br><span class="line"><span class="function"><span class="title">hello</span> <span class="title">world</span></span></span><br><span class="line"><span class="function"><span class="title">cron</span>: 2020/06/26 07:09:18 <span class="title">wake</span>, <span class="title">now</span>=2020-06-26<span class="title">T07</span>:09:18+08:00</span></span><br><span class="line"><span class="function"><span class="title">hello</span> <span class="title">world</span></span></span><br><span class="line"><span class="function"><span class="title">cron</span>: 2020/06/26 07:09:18 <span class="title">run</span>, <span class="title">now</span>=2020-06-26<span class="title">T07</span>:09:18+08:00, <span class="title">entry</span>=1, <span class="title">next</span>=2020-06-26<span class="title">T07</span>:09:19+08:00</span></span><br><span class="line"><span class="function"><span class="title">cron</span>: 2020/06/26 07:09:19 <span class="title">wake</span>, <span class="title">now</span>=2020-06-26<span class="title">T07</span>:09:19+08:00</span></span><br><span class="line"><span class="function"><span class="title">hello</span> <span class="title">world</span></span></span><br><span class="line"><span class="function"><span class="title">cron</span>: 2020/06/26 07:09:19 <span class="title">run</span>, <span class="title">now</span>=2020-06-26<span class="title">T07</span>:09:19+08:00, <span class="title">entry</span>=1, <span class="title">next</span>=2020-06-26<span class="title">T07</span>:09:20+08:0</span></span><br><span class="line"><span class="function">123456789101112131415161718</span></span><br></pre></td></tr></table></figure>

<p>我们看看默认的<code>Logger</code>是什么样的：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// logger.go</span></span><br><span class="line"><span class="keyword">var</span> DefaultLogger Logger = PrintfLogger(log.New(os.Stdout, <span class="string">"cron: "</span>, log.LstdFlags))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PrintfLogger</span><span class="params">(l <span class="keyword">interface</span>&#123; Printf(<span class="keyword">string</span>, ...<span class="keyword">interface</span>&#123;&#125;)</span> &#125;) <span class="title">Logger</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> printfLogger&#123;l, <span class="literal">false</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">VerbosePrintfLogger</span><span class="params">(l <span class="keyword">interface</span>&#123; Printf(<span class="keyword">string</span>, ...<span class="keyword">interface</span>&#123;&#125;)</span> &#125;) <span class="title">Logger</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> printfLogger&#123;l, <span class="literal">true</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> printfLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">  logger  <span class="keyword">interface</span>&#123; Printf(<span class="keyword">string</span>, ...<span class="keyword">interface</span>&#123;&#125;) &#125;</span><br><span class="line">  logInfo <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456789101112131415</span></span><br></pre></td></tr></table></figure>

<h3 id="WithChain"><a href="#WithChain" class="headerlink" title="WithChain"></a><code>WithChain</code></h3><p>Job 包装器可以在执行实际的<code>Job</code>前后添加一些逻辑：</p>
<ul>
<li>捕获<code>panic</code>；</li>
<li>如果<code>Job</code>上次运行还未结束，推迟本次执行;</li>
<li>如果<code>Job</code>上次运行还未介绍，跳过本次执行；</li>
<li>记录每个<code>Job</code>的执行情况。</li>
</ul>
<p>我们可以将<code>Chain</code>类比为 Web 处理器的中间件。实际上就是在<code>Job</code>的执行逻辑外在封装一层逻辑。我们的封装逻辑需要写成一个函数，传入一个<code>Job</code>类型，返回封装后的<code>Job</code>。<code>cron</code>为这种函数定义了一个类型<code>JobWrapper</code>：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chain.go</span></span><br><span class="line"><span class="keyword">type</span> JobWrapper <span class="function"><span class="keyword">func</span><span class="params">(Job)</span> <span class="title">Job</span></span></span><br><span class="line"><span class="function">12</span></span><br></pre></td></tr></table></figure>

<p>然后使用一个<code>Chain</code>对象将这些<code>JobWrapper</code>组合到一起：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Chain <span class="keyword">struct</span> &#123;</span><br><span class="line">  wrappers []JobWrapper</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewChain</span><span class="params">(c ...JobWrapper)</span> <span class="title">Chain</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> Chain&#123;c&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234567</span></span><br></pre></td></tr></table></figure>

<p>调用<code>Chain</code>对象的<code>Then(job)</code>方法应用这些<code>JobWrapper</code>，返回最终的`Job：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Chain)</span> <span class="title">Then</span><span class="params">(j Job)</span> <span class="title">Job</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="keyword">range</span> c.wrappers &#123;</span><br><span class="line">    j = c.wrappers[<span class="built_in">len</span>(c.wrappers)-i<span class="number">-1</span>](j)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> j</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456</span></span><br></pre></td></tr></table></figure>

<p>注意应用<code>JobWrapper</code>的顺序。</p>
<h3 id="内置JobWrapper"><a href="#内置JobWrapper" class="headerlink" title="内置JobWrapper"></a>内置<code>JobWrapper</code></h3><p><code>cron</code>内置了 3 个用得比较多的<code>JobWrapper</code>：</p>
<ul>
<li><code>Recover</code>：捕获内部<code>Job</code>产生的 panic；</li>
<li><code>DelayIfStillRunning</code>：触发时，如果上一次任务还未执行完成（耗时太长），则等待上一次任务完成之后再执行；</li>
<li><code>SkipIfStillRunning</code>：触发时，如果上一次任务还未完成，则跳过此次执行。</li>
</ul>
<p>下面分别介绍。</p>
<h4 id="Recover"><a href="#Recover" class="headerlink" title="Recover"></a><code>Recover</code></h4><p>先看看如何使用：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> panicJob <span class="keyword">struct</span> &#123;</span><br><span class="line">  count <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *panicJob)</span> <span class="title">Run</span><span class="params">()</span></span> &#123;</span><br><span class="line">  p.count++</span><br><span class="line">  <span class="keyword">if</span> p.count == <span class="number">1</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">"oooooooooooooops!!!"</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fmt.Println(<span class="string">"hello world"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  c := cron.New()</span><br><span class="line">  c.AddJob(<span class="string">"@every 1s"</span>, cron.NewChain(cron.Recover(cron.DefaultLogger)).Then(&amp;panicJob&#123;&#125;))</span><br><span class="line">  c.Start()</span><br><span class="line"></span><br><span class="line">  time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234567891011121314151617181920</span></span><br></pre></td></tr></table></figure>

<p><code>panicJob</code>在第一次触发时，触发了<code>panic</code>。因为有<code>cron.Recover()</code>保护，后续任务还能执行：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">go run main.go </span><br><span class="line"><span class="function">cron: 2020/06/27 14:02:00 <span class="title">panic</span>, <span class="title">error</span>=<span class="title">oooooooooooooops</span>!!!, <span class="title">stack</span>=...</span></span><br><span class="line"><span class="function"><span class="title">goroutine</span> 18 [<span class="title">running</span>]:</span></span><br><span class="line"><span class="function"><span class="title">github.com</span>/<span class="title">robfig</span>/<span class="title">cron</span>/<span class="title">v3.Recover.func1</span>.1.1(0<span class="title">x514ee0</span>, 0<span class="title">xc0000044a0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">D</span>:/<span class="title">code</span>/<span class="title">golang</span>/<span class="title">pkg</span>/<span class="title">mod</span>/<span class="title">github.com</span>/<span class="title">robfig</span>/<span class="title">cron</span>/<span class="title">v3</span>@<span class="title">v3</span>.0.1/<span class="title">chain.go</span>:45 +0<span class="title">xbc</span></span></span><br><span class="line"><span class="function"><span class="title">panic</span>(0<span class="title">x4cf380</span>, 0<span class="title">x513280</span>)</span></span><br><span class="line"><span class="function">        <span class="title">C</span>:/<span class="title">Go</span>/<span class="title">src</span>/<span class="title">runtime</span>/<span class="title">panic.go</span>:969 +0<span class="title">x174</span></span></span><br><span class="line"><span class="function"><span class="title">main</span>.(*<span class="title">panicJob</span>).<span class="title">Run</span>(0<span class="title">xc0000140e8</span>)</span></span><br><span class="line"><span class="function">        <span class="title">D</span>:/<span class="title">code</span>/<span class="title">golang</span>/<span class="title">src</span>/<span class="title">github.com</span>/<span class="title">darjun</span>/<span class="title">go</span>-<span class="title">daily</span>-<span class="title">lib</span>/<span class="title">cron</span>/<span class="title">recover</span>/<span class="title">main.go</span>:17 +0<span class="title">xba</span></span></span><br><span class="line"><span class="function"><span class="title">github.com</span>/<span class="title">robfig</span>/<span class="title">cron</span>/<span class="title">v3.Recover.func1</span>.1()</span></span><br><span class="line"><span class="function">        <span class="title">D</span>:/<span class="title">code</span>/<span class="title">golang</span>/<span class="title">pkg</span>/<span class="title">mod</span>/<span class="title">github.com</span>/<span class="title">robfig</span>/<span class="title">cron</span>/<span class="title">v3</span>@<span class="title">v3</span>.0.1/<span class="title">chain.go</span>:53 +0<span class="title">x6f</span></span></span><br><span class="line"><span class="function"><span class="title">github.com</span>/<span class="title">robfig</span>/<span class="title">cron</span>/<span class="title">v3.FuncJob.Run</span>(0<span class="title">xc000070390</span>)</span></span><br><span class="line"><span class="function">        <span class="title">D</span>:/<span class="title">code</span>/<span class="title">golang</span>/<span class="title">pkg</span>/<span class="title">mod</span>/<span class="title">github.com</span>/<span class="title">robfig</span>/<span class="title">cron</span>/<span class="title">v3</span>@<span class="title">v3</span>.0.1/<span class="title">cron.go</span>:136 +0<span class="title">x2c</span></span></span><br><span class="line"><span class="function"><span class="title">github.com</span>/<span class="title">robfig</span>/<span class="title">cron</span>/<span class="title">v3</span>.(*<span class="title">Cron</span>).<span class="title">startJob.func1</span>(0<span class="title">xc00005c0a0</span>, 0<span class="title">x514d20</span>, 0<span class="title">xc000070390</span>)</span></span><br><span class="line"><span class="function">        <span class="title">D</span>:/<span class="title">code</span>/<span class="title">golang</span>/<span class="title">pkg</span>/<span class="title">mod</span>/<span class="title">github.com</span>/<span class="title">robfig</span>/<span class="title">cron</span>/<span class="title">v3</span>@<span class="title">v3</span>.0.1/<span class="title">cron.go</span>:312 +0<span class="title">x68</span></span></span><br><span class="line"><span class="function"><span class="title">created</span> <span class="title">by</span> <span class="title">github.com</span>/<span class="title">robfig</span>/<span class="title">cron</span>/<span class="title">v3</span>.(*<span class="title">Cron</span>).<span class="title">startJob</span></span></span><br><span class="line"><span class="function">        <span class="title">D</span>:/<span class="title">code</span>/<span class="title">golang</span>/<span class="title">pkg</span>/<span class="title">mod</span>/<span class="title">github.com</span>/<span class="title">robfig</span>/<span class="title">cron</span>/<span class="title">v3</span>@<span class="title">v3</span>.0.1/<span class="title">cron.go</span>:310 +0<span class="title">x7a</span></span></span><br><span class="line"><span class="function"><span class="title">hello</span> <span class="title">world</span></span></span><br><span class="line"><span class="function"><span class="title">hello</span> <span class="title">world</span></span></span><br><span class="line"><span class="function"><span class="title">hello</span> <span class="title">world</span></span></span><br><span class="line"><span class="function"><span class="title">hello</span> <span class="title">world</span></span></span><br><span class="line"><span class="function">123456789101112131415161718192021</span></span><br></pre></td></tr></table></figure>

<p>我们看看<code>cron.Recover()</code>的实现，很简单：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cron.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Recover</span><span class="params">(logger Logger)</span> <span class="title">JobWrapper</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(j Job)</span> <span class="title">Job</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> FuncJob(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> size = <span class="number">64</span> &lt;&lt; <span class="number">10</span></span><br><span class="line">          buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, size)</span><br><span class="line">          buf = buf[:runtime.Stack(buf, <span class="literal">false</span>)]</span><br><span class="line">          err, ok := r.(error)</span><br><span class="line">          <span class="keyword">if</span> !ok &#123;</span><br><span class="line">            err = fmt.Errorf(<span class="string">"%v"</span>, r)</span><br><span class="line">          &#125;</span><br><span class="line">          logger.Error(err, <span class="string">"panic"</span>, <span class="string">"stack"</span>, <span class="string">"...\n"</span>+<span class="keyword">string</span>(buf))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;()</span><br><span class="line">      j.Run()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234567891011121314151617181920</span></span><br></pre></td></tr></table></figure>

<p>就是在执行内层的<code>Job</code>逻辑前，添加<code>recover()</code>调用。如果<code>Job.Run()</code>执行过程中有<code>panic</code>。这里的<code>recover()</code>会捕获到，输出调用堆栈。</p>
<h4 id="DelayIfStillRunning"><a href="#DelayIfStillRunning" class="headerlink" title="DelayIfStillRunning"></a><code>DelayIfStillRunning</code></h4><p>还是先看如何使用：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> delayJob <span class="keyword">struct</span> &#123;</span><br><span class="line">  count <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *delayJob)</span> <span class="title">Run</span><span class="params">()</span></span> &#123;</span><br><span class="line">  time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">  d.count++</span><br><span class="line">  log.Printf(<span class="string">"%d: hello world\n"</span>, d.count)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  c := cron.New()</span><br><span class="line">  c.AddJob(<span class="string">"@every 1s"</span>, cron.NewChain(cron.DelayIfStillRunning(cron.DefaultLogger)).Then(&amp;delayJob&#123;&#125;))</span><br><span class="line">  c.Start()</span><br><span class="line"></span><br><span class="line">  time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234567891011121314151617</span></span><br></pre></td></tr></table></figure>

<p>上面我们在<code>Run()</code>中增加了一个 2s 的延迟，输出中间隔变为 2s，而不是定时的 1s：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">go</span> run main.<span class="keyword">go</span> </span><br><span class="line"><span class="number">2020</span>/<span class="number">06</span>/<span class="number">27</span> <span class="number">14</span>:<span class="number">11</span>:<span class="number">16</span> <span class="number">1</span>: hello world</span><br><span class="line"><span class="number">2020</span>/<span class="number">06</span>/<span class="number">27</span> <span class="number">14</span>:<span class="number">11</span>:<span class="number">18</span> <span class="number">2</span>: hello world</span><br><span class="line"><span class="number">2020</span>/<span class="number">06</span>/<span class="number">27</span> <span class="number">14</span>:<span class="number">11</span>:<span class="number">20</span> <span class="number">3</span>: hello world</span><br><span class="line"><span class="number">2020</span>/<span class="number">06</span>/<span class="number">27</span> <span class="number">14</span>:<span class="number">11</span>:<span class="number">22</span> <span class="number">4</span>: hello world</span><br><span class="line"><span class="number">12345</span></span><br></pre></td></tr></table></figure>

<p>看看源码：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chain.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DelayIfStillRunning</span><span class="params">(logger Logger)</span> <span class="title">JobWrapper</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(j Job)</span> <span class="title">Job</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> mu sync.Mutex</span><br><span class="line">    <span class="keyword">return</span> FuncJob(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      start := time.Now()</span><br><span class="line">      mu.Lock()</span><br><span class="line">      <span class="keyword">defer</span> mu.Unlock()</span><br><span class="line">      <span class="keyword">if</span> dur := time.Since(start); dur &gt; time.Minute &#123;</span><br><span class="line">        logger.Info(<span class="string">"delay"</span>, <span class="string">"duration"</span>, dur)</span><br><span class="line">      &#125;</span><br><span class="line">      j.Run()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456789101112131415</span></span><br></pre></td></tr></table></figure>

<p>首先定义一个该任务共用的互斥锁<code>sync.Mutex</code>，每次执行任务前获取锁，执行结束之后释放锁。所以在上一个任务结束前，下一个任务获取锁是无法成功的，从而保证的任务的串行执行。</p>
<h4 id="SkipIfStillRunning"><a href="#SkipIfStillRunning" class="headerlink" title="SkipIfStillRunning"></a><code>SkipIfStillRunning</code></h4><p>还是先看看如何使用：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> skipJob <span class="keyword">struct</span> &#123;</span><br><span class="line">  count <span class="keyword">int32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *skipJob)</span> <span class="title">Run</span><span class="params">()</span></span> &#123;</span><br><span class="line">  atomic.AddInt32(&amp;d.count, <span class="number">1</span>)</span><br><span class="line">  log.Printf(<span class="string">"%d: hello world\n"</span>, d.count)</span><br><span class="line">  <span class="keyword">if</span> atomic.LoadInt32(&amp;d.count) == <span class="number">1</span> &#123;</span><br><span class="line">    time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  c := cron.New()</span><br><span class="line">  c.AddJob(<span class="string">"@every 1s"</span>, cron.NewChain(cron.SkipIfStillRunning(cron.DefaultLogger)).Then(&amp;skipJob&#123;&#125;))</span><br><span class="line">  c.Start()</span><br><span class="line"></span><br><span class="line">  time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">12345678910111213141516171819</span></span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">go</span> run main.<span class="keyword">go</span></span><br><span class="line"><span class="number">2020</span>/<span class="number">06</span>/<span class="number">27</span> <span class="number">14</span>:<span class="number">22</span>:<span class="number">07</span> <span class="number">1</span>: hello world</span><br><span class="line"><span class="number">2020</span>/<span class="number">06</span>/<span class="number">27</span> <span class="number">14</span>:<span class="number">22</span>:<span class="number">10</span> <span class="number">2</span>: hello world</span><br><span class="line"><span class="number">2020</span>/<span class="number">06</span>/<span class="number">27</span> <span class="number">14</span>:<span class="number">22</span>:<span class="number">11</span> <span class="number">3</span>: hello world</span><br><span class="line"><span class="number">2020</span>/<span class="number">06</span>/<span class="number">27</span> <span class="number">14</span>:<span class="number">22</span>:<span class="number">12</span> <span class="number">4</span>: hello world</span><br><span class="line"><span class="number">2020</span>/<span class="number">06</span>/<span class="number">27</span> <span class="number">14</span>:<span class="number">22</span>:<span class="number">13</span> <span class="number">5</span>: hello world</span><br><span class="line"><span class="number">2020</span>/<span class="number">06</span>/<span class="number">27</span> <span class="number">14</span>:<span class="number">22</span>:<span class="number">14</span> <span class="number">6</span>: hello world</span><br><span class="line"><span class="number">2020</span>/<span class="number">06</span>/<span class="number">27</span> <span class="number">14</span>:<span class="number">22</span>:<span class="number">15</span> <span class="number">7</span>: hello world</span><br><span class="line"><span class="number">2020</span>/<span class="number">06</span>/<span class="number">27</span> <span class="number">14</span>:<span class="number">22</span>:<span class="number">16</span> <span class="number">8</span>: hello world</span><br><span class="line"><span class="number">123456789</span></span><br></pre></td></tr></table></figure>

<p>注意观察时间，第一个与第二个输出之间相差 3s，因为跳过了两次执行。</p>
<p>注意<code>DelayIfStillRunning</code>与<code>SkipIfStillRunning</code>是有本质上的区别的，前者<code>DelayIfStillRunning</code>只要时间足够长，所有的任务都会按部就班地完成，只是可能前一个任务耗时过长，导致后一个任务的执行时间推迟了一点。<code>SkipIfStillRunning</code>会跳过一些执行。</p>
<p>看看源码：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SkipIfStillRunning</span><span class="params">(logger Logger)</span> <span class="title">JobWrapper</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(j Job)</span> <span class="title">Job</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">1</span>)</span><br><span class="line">    ch &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">    <span class="keyword">return</span> FuncJob(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">select</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> v := &lt;-ch:</span><br><span class="line">        j.Run()</span><br><span class="line">        ch &lt;- v</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        logger.Info(<span class="string">"skip"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456789101112131415</span></span><br></pre></td></tr></table></figure>

<p>定义一个该任务共用的缓存大小为 1 的通道<code>chan struct{}</code>。执行任务时，从通道中取值，如果成功，执行，否则跳过。执行完成之后再向通道中发送一个值，确保下一个任务能执行。初始发送一个值到通道中，保证第一个任务的执行。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>cron</code>实现比较小巧，且优雅，代码行数也不多，非常值得一看！</p>
<p>大家如果发现好玩、好用的 Go 语言库，欢迎到 Go 每日一库 GitHub 上提交 issue😄</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li>cron GitHub：<a href="https://github.com/robfig/cron" target="_blank" rel="noopener">https://github.com/robfig/cron</a></li>
<li>Go 每日一库之 carbon：<a href="https://darjun.github.io/2020/02/14/godailylib/carbon/" target="_blank" rel="noopener">https://darjun.github.io/2020/02/14/godailylib/carbon/</a></li>
<li>Go 每日一库之 gron：<a href="https://darjun.github.io/2020/04/20/godailylib/gron/" target="_blank" rel="noopener">https://darjun.github.io/2020/04/20/godailylib/gron/</a></li>
<li>Go 每日一库 GitHub：<a href="https://github.com/darjun/go-daily-lib" target="_blank" rel="noopener">https://github.com/darjun/go-daily-lib</a></li>
</ol>
<h2 id="文章来源"><a href="#文章来源" class="headerlink" title="文章来源"></a>文章来源</h2><p>博客：<a href="https://darjun.github.io/" target="_blank" rel="noopener">https://darjun.github.io</a></p>
<p>微信公众号【GoUpUp】，共同学习，一起进步~</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/go/" rel="tag"># go</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2020/06/05/Nginx%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E4%B8%AD%E6%96%87%E8%AF%A6%E7%BB%86%E8%AF%B4%E6%98%8E/" rel="next" title="Nginx配置参数中文详细说明">
                  <i class="fa fa-chevron-left"></i> Nginx配置参数中文详细说明
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/2021/05/25/python%E8%B7%AF%E5%BE%84%E6%93%8D%E4%BD%9C%E6%96%B0%E6%A0%87%E5%87%86%EF%BC%9Apathlib-%E6%A8%A1%E5%9D%97/" rel="prev" title="python路径操作新标准：pathlib 模块">
                  python路径操作新标准：pathlib 模块 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#快速使用"><span class="nav-number">2.</span> <span class="nav-text">快速使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#时间格式"><span class="nav-number">3.</span> <span class="nav-text">时间格式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#预定义时间规则"><span class="nav-number">3.1.</span> <span class="nav-text">预定义时间规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#固定时间间隔"><span class="nav-number">3.2.</span> <span class="nav-text">固定时间间隔</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#时区"><span class="nav-number">4.</span> <span class="nav-text">时区</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Job接口"><span class="nav-number">5.</span> <span class="nav-text">Job接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#线程安全"><span class="nav-number">6.</span> <span class="nav-text">线程安全</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义时间格式"><span class="nav-number">7.</span> <span class="nav-text">自定义时间格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#选项"><span class="nav-number">8.</span> <span class="nav-text">选项</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#WithLogger"><span class="nav-number">8.1.</span> <span class="nav-text">WithLogger</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WithChain"><span class="nav-number">8.2.</span> <span class="nav-text">WithChain</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内置JobWrapper"><span class="nav-number">8.3.</span> <span class="nav-text">内置JobWrapper</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Recover"><span class="nav-number">8.3.1.</span> <span class="nav-text">Recover</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DelayIfStillRunning"><span class="nav-number">8.3.2.</span> <span class="nav-text">DelayIfStillRunning</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SkipIfStillRunning"><span class="nav-number">8.3.3.</span> <span class="nav-text">SkipIfStillRunning</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">9.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">10.</span> <span class="nav-text">参考</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文章来源"><span class="nav-number">11.</span> <span class="nav-text">文章来源</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="解百忧"
    src="/uploads/avatar.jpg">
  <p class="site-author-name" itemprop="name">解百忧</p>
  <div class="site-description" itemprop="description">分享学习记录</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/jiebaiyou" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;jiebaiyou" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jiebaiyou@gmail.com" title="E-Mail &amp;rarr; mailto:jiebaiyou@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      友情链接
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://www.orivon.com/" title="http:&#x2F;&#x2F;www.orivon.com" rel="noopener" target="_blank">Orivon</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">解百忧</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  






  
<script src="/js/local-search.js"></script>














  

  

  

</body>
</html>
